<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-1">
        <createTable tableName="address">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_address"/>
            </column>
            <column name="country" type="VARCHAR(50)"/>
            <column name="region" type="VARCHAR(50)"/>
            <column name="district" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="street" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="postal_code" type="VARCHAR(32)"/>
            <column name="house" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="apt" type="VARCHAR(10)"/>
            <column defaultValueComputed="now()" name="last_updated" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-2">
        <createTable tableName="author">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_author"/>
            </column>
            <column name="author_name" type="VARCHAR(45)"/>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-3">
        <createTable tableName="book">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_book"/>
            </column>
            <column name="title" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="isbn_10" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="isbn_13" type="VARCHAR(13)">
                <constraints nullable="false"/>
            </column>
            <column name="category_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="publisher_id" type="INTEGER"/>
            <column name="language" remarks="Language of book by alpha-3/ISO 639-2 Code" type="VARCHAR(3)"/>
            <column name="publishing_date" type="date"/>
            <column name="print_length" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="picture_url" type="VARCHAR(2083)"/>
            <column name="attributes" type="JSON"/>
            <column name="total_count" type="INTEGER"/>
            <column name="available_count" type="INTEGER"/>
            <column defaultValueBoolean="true" name="available" type="BOOLEAN"/>
            <column defaultValueNumeric="0" name="book_rating" remarks="Book rating, count of booking" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="book_created" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="book_updated" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-4">
        <createTable tableName="book_has_author">
            <column name="book_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="author_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-5">
        <createTable tableName="category">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_category"/>
            </column>
            <column name="parent_id" type="INTEGER"/>
            <column name="category_name" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-6">
        <createTable tableName="publisher">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_publisher"/>
            </column>
            <column name="publisher_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-7">
        <createTable tableName="review">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_review"/>
            </column>
            <column name="book_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="review_text" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="review_grade" type="SMALLINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="review_created" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="review_updated" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-8">
        <createTable tableName="role">
            <column autoIncrement="true" name="id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_role"/>
            </column>
            <column name="role_name" type="VARCHAR(45)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-9">
        <createTable tableName="subscription">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_subscription"/>
            </column>
            <column name="status_code" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="book_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="took" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column defaultValueNumeric="0" name="returned" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="subscription_created" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="subscription_deadline" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-10">
        <createTable tableName="user">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_user"/>
            </column>
            <column name="email" type="VARCHAR(80)"/>
            <column name="username" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(15)"/>
            <column name="last_name" type="VARCHAR(15)"/>
            <column name="middle_name" type="VARCHAR(15)"/>
            <column name="phone_number" type="JSON"/>
            <column name="address_id" type="BIGINT"/>
            <column defaultValue="u" name="gender" remarks="Gender: m-male, f-female, u-unknown" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>
            <column name="birthday" type="date"/>
            <column name="password" remarks="Password encoded with using BCryptPasswordEncoder" type="VARCHAR(64)"/>
            <column defaultValueBoolean="true" name="enabled" type="BOOLEAN"/>
            <column name="avatar_url" type="VARCHAR(2083)"/>
            <column defaultValueComputed="now()" name="user_created" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="now()" name="user_updated" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-11">
        <createTable tableName="user_has_role">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="user_has_role_pkey"/>
            </column>
            <column name="role_id" type="INTEGER">
                <constraints nullable="false" primaryKey="true" primaryKeyName="user_has_role_pkey"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko" id="2021-05-13--01-initial-schema-12">
        <createTable tableName="user_social_id">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="social_id" remarks="Users social id (ex. facebook, github, google)" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-13">
        <addUniqueConstraint columnNames="author_name" constraintName="author_author_name_key" tableName="author"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-14">
        <addUniqueConstraint columnNames="category_name" constraintName="category_category_name_key" tableName="category"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-15">
        <addForeignKeyConstraint baseColumnNames="category_id" baseTableName="book" constraintName="fk_book_category" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="category" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-16">
        <addUniqueConstraint columnNames="role_name" constraintName="role_role_name_key" tableName="role"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-17">
        <addUniqueConstraint columnNames="publisher_name" constraintName="publisher_publisher_name_key" tableName="publisher"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-18">
        <createIndex indexName="user_email_key" tableName="user" unique="true">
            <column name="email"/>
        </createIndex>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-19">
        <addForeignKeyConstraint baseColumnNames="book_id" baseTableName="subscription" constraintName="fk_subscription_book" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="book" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-20">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="subscription" constraintName="fk_subscription_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="user" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-21">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="user_social_id" constraintName="fk_user_user_social_id" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="user" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-22">
        <createIndex indexName="user_social_id_social_id_key" tableName="user_social_id" unique="true">
            <column name="social_id"/>
        </createIndex>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-23">
        <addForeignKeyConstraint baseColumnNames="author_id" baseTableName="book_has_author" constraintName="fk_book_has_author_author1" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="author" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-24">
        <addForeignKeyConstraint baseColumnNames="book_id" baseTableName="book_has_author" constraintName="fk_book_has_author_book1" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="book" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-25">
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="category" constraintName="fk_category_category1" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="category" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-26">
        <addForeignKeyConstraint baseColumnNames="book_id" baseTableName="review" constraintName="fk_review_book" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="book" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-27">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="review" constraintName="fk_review_user" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="user" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-28">
        <addForeignKeyConstraint baseColumnNames="publisher_id" baseTableName="book" constraintName="fk_book_publisher" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="publisher" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-29">
        <addForeignKeyConstraint baseColumnNames="role_id" baseTableName="user_has_role" constraintName="fk_user_has_role_role1" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="role" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-30">
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="user_has_role" constraintName="fk_user_has_role_user1" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="user" validate="true"/>
    </changeSet>
    <changeSet author="Aliaksandr Rachko (generated)" id="2021-05-13--01-initial-schema-31">
        <addForeignKeyConstraint baseColumnNames="address_id" baseTableName="user" constraintName="fk_user_address" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="address" validate="true"/>
    </changeSet>
</databaseChangeLog>